<!DOCTYPE html>
<head><meta charset="utf-8"><title>kdb</title></head>
<link rel=icon href='data:;base64,iVBORw0KGgoAAAANSUhEUgAAABAAAAAQAgMAAABinRfyAAAACVBMVEX/AAAAAAD////KksOZAAAAMElEQVR4nGJYtWrVKoYFq1ZxMSyYhkZMgxNRXAwLpmbBCDAXSRZEgAwAGQUIAAD//+QzHr+8V1EyAAAAAElFTkSuQmCC'>


<style>
 body{font-family:monospace}
 button{font-family:monospace;background-color:white;border:1px solid black}
 button:active{transform:translateY(1px)}
 .container{/*max-width:940px*/;display:grid;grid-template-columns:1fr 4fr;grid-column-gap: 7px;}
 .header{grid-column-start:1;grid-column-end:-1;}
 .footer{grid-column-start:1;grid-column-end:-1;}
 .selected{border:2px solid black;transform:translateY(2px)}
 .hidden{display:none}
 select{width:100%}
 option{font-family:monospace}
 #inp{width:100%;height:35vh}
 #crs{width:100%;height:35vh}
 #out > textarea{width:100%;height:25vh}
 #val{width:100%;height:25vh}
 #edt{background-color}
</style>

<body>
<div class="container">
 <header class="header">
  <div class="container">
   <div style="display:flex;gap:5px">
    <button id="stp">stp</button>
    <button id="cnt">cnt</button>
    <div style="margin-left:auto"></div>
    <button id="sym">stk/sym</button>
   </div>
   <div>
    <button id="run">run</button>
    <button id="edt" class="selected">edt</button>
    <button id="src">src</button>
   </div>
  </div>
 </header>
 <aside class="sidebar">
  <div id="stks">
   <pre>call stack</pre>
   exec
   <select id="exec" size="8">
    <option>1</option>
    <option>2</option>
   </select>
   k stack
   <select id="stack" size="8">
    <option>1</option>
    <option>2</option>
   </select>
  </div> 
  <div id="syms" class="hidden">
  symbols <input id="fsym" style="margin-left:2em"></input><br>
   <select id="tab" size="24">
    <option>x</option>
    <option>y</option>
    <option>z</option>
   </select>
  </div>
 </aside> 
 <main class="main">
  <textarea id="inp">1+ \2 3 4</textarea>
  <textarea id="crs" class="hidden">src</textarea>
  <div id="out" data-k-type="tty" data-k-val='""'>def</div>
  <div id="val">1 2 3</div>
 </main>
</div>


<script type="module">

import {kweb} from './kweb.js'
import {K} from '../k.js'

function ce(x) { return document.createElement(x) }
function ge(x) { return document.getElementById(x) }
function rm(p){while(p.firstChild)p.removeChild(p.firstChild)}
function lo(x){return Number(BigInt.asUintN(32,x))}         // 32-bit of BigInt serves as the wasm memory index (pointer).
function su(u){return (u.length)?new TextDecoder("utf-8").decode(u):""}
function C(){ return new     Int8Array(K._.memory.buffer) }
function U(){ return new   Uint32Array(K._.memory.buffer) }
function I(){ return new    Int32Array(K._.memory.buffer) }
function J(){ return new BigInt64Array(K._.memory.buffer) }
function F(){ return new  Float64Array(K._.memory.buffer) }
function con(x){ return ge("out").firstElementChild }

ge("run").onclick=function(){
 con().value=""
 kweb.ktry(ge("inp").value)
 ge("crs").value=cc(K._.src())
 srcinp(1)
}

function srcinp(x){
 let b=["edt","src"]
 console.log(b[x-0], b[1-x])
 ge(b[x-0]).classList.add("selected"); 
 ge(b[1-x]).classList.remove("selected")
 ge("crs").classList[["add","remove"][x]]("hidden")
 ge("inp").classList[["remove","add"][x]]("hidden")
}
ge("edt").onclick=function(){srcinp(0)}
ge("src").onclick=function(){srcinp(1)}

ge("sym").onclick=function(){
 ge("stks").classList.toggle("hidden")
 if(!ge("syms").classList.toggle("hidden")) loadsym()
}
ge("fsym").onchange=function(e){
 let s=e.target.value
 let tab=ge("tab");let opts=tab.children
 for(let i=0;i<opts.length;i++){
  let t=opts[i].textContent
  if(t.startsWith(s)){ tab.selectedIndex=i;return }
 }
}

function loadsym(){
 let tab=ge("tab");rm(tab)
 let j=J();let i=I()
 let p=i[0] >>> 3
 let q=lo(j[1]) >>> 3
 let n=K.NK(j[0])
 for(let i=0;i<n;i++){
  let o=ce("option");
  let x=j[q+i]
  let s=cc(j[p+i])
  s+="&nbsp;".repeat((s.length>10)?0:10-s.length)
  let t=K.TK(x)
  if(0<="CIFZLDT".indexOf(t))s+=String(K.NK(x))+"#"+t
  else s+=t
  if(0<="0ci".indexOf(t))s+=": "+lo(x)
  o.innerHTML=s
  tab.appendChild(o)
 }
}
function cc(x){ return su(C().slice(lo(x),lo(x)+K.NK(x))) }

kweb.O = function(x){console.log("k>>",x)}

function dbg(x){console.log("dbg",x)}
function step(p,sp,a){console.log("step",p,sp,a)}

function post(){con().readOnly=true}
kweb.init(function(){}, "../d.wasm", post, {dbg:dbg,step:step})

</script>
</body>
</html>
