set -e
set -x
rm -f out out.go in.go *.wasm


if [ -z "$1" ]; then
	for f in *.go; do
		go fmt $f
		k=`echo $f | sed 's/.go$/.k/'`
		wg -k $f > $k
	done
elif [ "$1" = go ]; then
	for x in *.k; do
		g=`echo $x | sed 's/.k$/.go/'`
		k $x ../go.k -e 'x:`<go``nort' > out.go
		go fmt out.go
		grep -v '^import' $g > in.go
		go fmt in.go
		cmp out.go in.go
		rm out.go in.go
	done
elif [ "$1" = wa ]; then
	for x in *.k; do
		w=`echo $x | sed 's/.k$/.wa/'`
		k $x ../wa.k -e 'x:`<wa``nort' > out
		cmp out $w
		rm out
	done
elif [ "$1" = i ];then
 	for x in *.k; do
		o=`echo $x | sed 's/.k$/.i/'`
	 	k $x ../ik.k -e 'x:`<ik``' > $o
	done
elif [ "$1" = ki ]; then
        #for x in *.k; do
	# cnd.k const.k cont.k heap.k ifret.k label.k lit.k loop.k loop2.k mem.k swtch.k tab.k
	for x in inc.k cast.k asn.k cal.k cli.k drp.k fun.k; do
	 i=`echo $x | sed 's/.k$/.i/'`
	 k ../ki.k -e 'x:kixx@<`"'$i'"' > out1
 	 k ${x}  -e 'x:`<"\n"/:(`lxy 40 100)@+`T`P`I`S!(T;P;I;S)' > out2
	 diff out1 out2
	done
elif [ "$1" = walidate ]; then
	for x in *.wa; do
		/c/local/wabt/wat2wasm $x
	done
	rm *.wasm
else
	echo 1
fi

