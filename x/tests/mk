set -e
set -x
rm -f out out.go in.go *.wasm


if [ -z "$1" ]; then
	for f in *.go; do
		go fmt $f
		k=`echo $f | sed 's/.go$/.k/'`
		wg -k $f > $k
	done
elif [ "$1" = go ]; then
	for x in *.k; do
		g=`echo $x | sed 's/.k$/.go/'`
		k $x ../go.k -e 'x:`<emit go``nort' > out.go
		go fmt out.go
		grep -v '^import' $g > in.go
		go fmt in.go
		cmp out.go in.go
		rm out.go in.go
	done
elif [ "$1" = wa ]; then
	#for x in *.k; do
	#nyi:blank cal cli cont fun label lit loop loop2 mem tab
	for x in asn.k drp.k cast.k swtch.k cnd.k heap.k const.k; do
		w=`echo $x | sed 's/.k$/.wa/'`
		k $x ../wa.k -e 'x:`<emit wa``' > out
		cmp out $w
		rm out
	done
elif [ "$1" = walidate ]; then
	for x in *.wa; do
		/c/local/wabt/wat2wasm $x
	done
	rm *.wasm
else
	echo 1
fi


