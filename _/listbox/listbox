<head><meta charset="utf-8"><title>listbox</title></head>
<link rel='icon' type'image/png' href="k32.png">
<style>
 html,body{height:100%;margin:0;padding:0;overflow:hidden;display:flex;flex-flow:column;}
 #tags{flex: 0 1 auto;background:#ffffea;font-family:monospace;font-size:100%;border:none;border-bottom:1px solid black;}
 #list{flex: 1 1 auto;background:#ffffea;font-family:monospace;font-size:100%;border:none;}
 #canv{flex: 1 1 auto;background:#777777;font-family:monospace;font-size:100%;display:none;}
 #edit{flex: 1 1 auto;background:#ffffea;font-family:monospace;font-size:100%;display:none;margin:0;border:1px solid blue;}
 #butn{flex: 0 1 auto;background:#ffffea;font-family:monospace;font-size:100%;border:none;display:none;}#ok{width:10%}#cancel{width:10%}#err{width:80%;background:#ffffea;border:none;}
</style>
<input    id="tags" >
<select   id="list" multiple></select>
<textarea id="edit" wrap="off" spellcheck="false"></textarea>
<canvas   id="canv" ></canvas>
<div      id="butn" ><button id="ok">ok</button><button id="cancel">cancel</button><input id="err" readonly></div>
<a        id="save" ></a>
<script>
function display(x){[list,canv,edit,butn].forEach(i=>i.style.display="none");x.style.display="block";}
function pd(e){if(e){e.preventDefault();e.stopPropagation()}};

var hist=[""];function addhist(x){if(!hist.includes(x))hist.unshift(x)};function gethist(x){if(x)hist.unshift(hist.pop());else hist.push(hist.shift());tags.value=hist[0]}
tags.onkeydown = function(e){var k=e.which;
 if(k==13){var s=tags.value.substring(tags.selectionStart,tags.selectionEnd);
  if(s.length==0){s=tags.value;addhist(s);tags.value=""};
  if(s.length==0)return start()
  EO(" "+s+"\n"+repl(s))
 }
 if(k==38){gethist(false)}if(k==40){gethist(true)} }
tags.ondblclick = function(e){exec(tags.value.substring(tags.selectionStart,tags.selectionEnd).trim())}
canv.tabIndex=100;canv.onkeydown=function(e){if(e.which==27)display(list)}

document.body.onkeydown = function(e){if(e.which==27){drop()}}
list.onkeydown = function(e){if(e.which==13){pd(e);push()}}
list.ondblclick= function(e){pd(e);push()}
ok.onclick     = function(e){asin(edit.value)}
cancel.onclick = drop

function start(){
 var t=1<<K.I[32];var f=0;var s=8;var u;for(var i=4;i<32;i++){s=2*s;for(var u=K.I[i];u!=0;u=K.I[u>>>2])f+=s}
 EO(ver+" "+String(t-f)+"/"+String(t)) // used/total
}
function load(s){document.title=s;fetch(s).then(r=>{return r.text()}).then(s=>{EO(repl(stripDoc(s)));tag()})}
function stripDoc(s){return s.split("\n\\")[0]}
var prog=decodeURIComponent(window.location.hash.substr(1))

// k.wasm module
var ver   = "k.w "
var hlp   = ""; fetch('h').then(r=>{return r.text()}).then(s=>{hlp=s;ver+=s.split("\n")[0];EO(ver)})
var src   = ""; fetch('s').then(r=>{return r.text()}).then(s=>{src=s})
var EO    = function(s)    {edit.value=s;display(edit)}
var draw  = function(w,h,p){ console.log("draw: nyi") }
var grow  = function(x)    {var cur=K.exports.mem.buffer.byteLength;if((1<<x)>cur){var a=(1<<x)-cur;K.exports.mem.grow(a>>>16); msl()};return x}
var printc= function(x,y)  {EO(logg(su(K.C.slice(x,x+y))+"\n"))}
var msl   = function()     {var b=K.exports.mem.buffer;K.C=new Uint8Array(b);K.U=new Uint32Array(b);K.I=new Int32Array(b);K.F=new Float64Array(b)}
var nn, tp, dx, mk, val, kst, bak
WebAssembly.instantiateStreaming(fetch('k.wasm'), { "ext": {"sin":Math.sin,"cos":Math.cos,"exp":Math.exp,"log":Math.log,"atan2":Math.atan2,"hypot":Math.hypot,"draw":draw,"grow":grow,"printc":printc} }).then(r=>{
 K=r.instance;msl();K.exports.ini(16);bak=K.C.slice(0)
 nn=K.exports.nn;tp=K.exports.tp;dx=K.exports.dx;rx=K.exports.rx;mk=K.exports.mk;val=K.exports.val;kst=K.exports.kst
 EO(repl(listbox));if(prog.length>0)load(prog)
});

function us(s) { return new TextEncoder("utf-8").encode(s) }
function su(u) { return (u.length) ? new TextDecoder("utf-8").decode(u) : "" }
function sk(x) { if(x<0)return"!";if(tp(x)!=1){dx(x);return""};var n=nn(x);dx(x);return su(K.C.slice(8+x, 8+x+n))}
function cS(s) { var u=us(s);var x=mk(1,u.length);K.C.set(u,8+x);return x }
function Rx(x) { rx(x);return x}
function ktry(s) {
 try     {var x=val(cS(s)); bak=K.C.slice(0, 1<<K.U[32]);return x}
 catch(e){console.log(e);K.C.set(bak);return -1}}


function repl(x,t){t=x.trim();if(t.length==0)return;if(t==="\\")return hlp;x=ktry(x);return (x<0)?"!":sk(tp(x)==1?x:kst(x))} // press enter on the tag bar
function exec(x  ){disp(ktry("exec`"+x));tag()}                                                                              // double-click a word in the tag bar
function push(x  ){disp(ktry("push "+sel()));tag()}                                                                          // double click on list entry or press enter(multiple selections)
function drop(x  ){disp(ktry("drop[]"));tag()}                                                                               // go backwards(upwards) one level on ESC key
function disp(x,t){if(x<=0)return EO((x<0)?"!":"");t=tp(x);if(t==1)ED(sk(x));if(t==6)LO(x)}                                  // display result in a listbox or the editor
function asin(x,r){r=ktry("asin "+x);if(r==0)drop();else serr((r==-1)?"!":sk(r))}                                            // ok button clicked when editing a variable

function jk(x,r,p){if(tp(x)!=6)return (tp(x)==1)?sk(x):"!!";r=[];p=(8+x)>>>2;for(var i=0;i<nn(x);i++)r.push(sk(Rx(K.I[p+i])));dx(x);return r} // jk expects "abc" or ("abc";"def")
function LO(x){x=jk(x);clr();for(var i=0;i<x.length;i++){var o=document.createElement("option");o.text=x[i];o.innerHTML=nbsp(o.innerHTML);list.add(o)};display(list)}
function nbsp(x){return x.split(" ").join("&nbsp;")}
function clr(n){n=list.options.length;for(var i=n-1;i>=0;i--)list.options[i]=null;}
function sel(s){s=Array.from(list.selectedOptions).map(v=>v.index).join(" ");return(s=="")?"()":s}
function ED(x){serr("");err.value="";EO(x);butn.style.display="block"}
function serr(x){err.value=logg(x);err.style.border=(x.length==0)?"none":"1px solid red"}
function tag(r){tags.value=sk(ktry("tag path"))}

var listbox = `
"todo: copy header of example.k here"
`
function logg(x){console.log(x);return x}
</script><body></body></html>