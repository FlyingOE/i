# current version: see tinygo

# k(wasm) 2.1MB
#
# install go-1.13
go=/c/go

set -e
cp ../../k.go .
GOOS=js GOARCH=wasm go build -o k.w
base64 -w 0 k.w | sed -e 's/^/var r = "/' -e 's/$/"/' > k.b64
base64 -w 0 ../../u/t.k       | sed -e 's/^/var tk = "/' -e 's/$/"/' > tk.b64
base64 -w 0 ../../u/f/vt220.k | sed -e 's/^/var f0 = "/' -e 's/$/"/' > f0.b64
base64 -w 0 ../../u/f/f1.k    | sed -e 's/^/var f1 = "/' -e 's/$/"/' > f1.b64
base64 -w 0 ../../u/f/f2.k    | sed -e 's/^/var f2 = "/' -e 's/$/"/' > f2.b64
base64 -w 0 ../../u/f/f3.k    | sed -e 's/^/var f3 = "/' -e 's/$/"/' > f3.b64
cp $go/misc/wasm/wasm_exec.js .
git rev-parse --short HEAD | sed -e 's/^/var rev = "/' -e 's/$/"/' > rev

# replace {{file}} in k.ht
awk '/^{{/{
 f=substr($0, 3, length($0)-4)
 while((getline l<f)>0) print l
 next
}{print}' k.ht > index.html

if [ "$1" = "deploy" ]; then
	cp index.html ../../../ktye.github.io/index.html
fi

# run local file:///path/to/index.html or ktye.github.io
# example:
# ktye.github.io/#f%3A%7Bt%2Fx%2Ft%3A%25n%251-2*2%5Ct%2F%2Bt%3A%2B2%5C%3A!n%3A%23x%7D%3Bf%200.%2B(1%200%200%200%3B1%201%200%200%3B1%201%201%200%3B1%201%201%201)
