<head><meta charset="utf-8"><title>w</title></head>
<link rel='icon' type'image/png' href="k32.png">
<style>
 html,body,textarea,input,select{height:100%;margin:0;padding:0;overflow:hidden;font-family:monospace;}
 #kons{top:0;left:0;width:100%;height:100%;position:absolute;border:0pt;resize:none;overflow:auto;}
 .term{background:black;color:white}
 .hold{background:white;color:black}
 .edit{background:#ffffea;color:black}
 #cnv{width:100;height:100;top:0;right:0;position:absolute;}
 #dl{display:none;}
</style>
<body>
<textarea id="kons" class="term" wrap="off" autofocus spellcheck="false"></textarea>
<canvas id="cnv"></canvas>
<a id="dl"></a>
<script>
var r = "{{wasm}}"
var rt = "{{tests}}"
var rs = "{{src}}"
var help = "{{help}}"
var G = {};var gui
{{gui}}
function sa(s){var r=new Uint8Array(new ArrayBuffer(s.length));for(var i=0;i<s.length;i++)r[i]=s.charCodeAt(i);return r}
function pd(e){if(e){e.preventDefault();e.stopPropagation()}};
function ae(x,y,z){x.addEventListener(y,z)};
var kwasm = sa(atob(r))
var tests = atob(rt)
var src = atob(rs)
var K,nn,tp,mk,rx,dx,mk,val,sc,cs,mkd,asn,kst,enl,lup,cat,lcat,atx,mki,til
// kons (k console)
var hit = kons
var konstore = ""
var edname = ""
var ed = false
var ctx
var tick
function initKons() {
 kons.value = "{{cons}}"
 var hold = false
 kons.onkeydown = function(e) {
  if(e.which === 27) { // quit edit / toggle hold / close image / stop loop
   clearInterval(tick)
   pd(e)
   if (ed) { qed(); hold=true }
   hold = !hold
   kons.className = (hold) ? "hold" : "term"
   imgSize(0, 0)
   hit = kons
  } else if (e.which === 13 && !hold && !ed) { // execute
   pd(e)
   var a = kons.selectionStart
   var b = kons.selectionEnd
   var s = kons.value.substring(a, b)
   if (b == a) {
    if (kons.value[a] == "\n") a -= 1
    a = kons.value.lastIndexOf("\n", a)
    if (a == -1) a = 0
    b = kons.value.indexOf("\n", b)
    if (b == -1) b = kons.value.length
    s = kons.value.substring(a, b)
   }
   if (kons.selectionEnd != kons.value.length) O(s)
   O("\n")
   var s = s.trim()
   if(s.length>0&&s[0]=="'")s=" "+s //spacy verb
   if (s === "\\tests")         {O(tests);                        return}
   if (s === "\\src")           {O(src);                          return}
   if((s === "\\")||(s==="\\h")){O(atob(help));P();               return}
   if (s === "\\c")             {kons.value=" ";imgSize(0, 0);    return}
   if (s === "\\d")             {dump(0, 200);P();                return}
   if (s.startsWith("\\e"))     {P();edit(s.substr(2).trim());    return}
   if (s.startsWith("\\w"))     {download(s.substr(2).trim());P();return}
   if (s.startsWith("\\g"))     {mkgui(s.substr(2).trim());P();   return}
   if (s.startsWith("\\L"))     {P();loop(s.slice(2));            return}
   else if (s.startsWith("\\")) {O("?");P();                      return}
   hash(s);E(s);P()
  }
 }
 kons.onmousedown = function(e) { hit=kons; if(e.button==2)pd(e); }
 kons.onblur  = function(e) { kons.style.filter = "brightness(70%)" }
 kons.onfocus = function(e) { kons.style.filter = "brightness(100%)" }
 ctx = cnv.getContext('2d')
}
function indicate(line, col) {
 if(line==0)O("error\n")
 else O(src.split("\n")[line-1] + "\n" + " ".repeat(col) + "^\n")
}
function loop(s) {var v,t,f;v=s.split(" ");t=parseInt(v[0],10);if(!isNaN(t))v=v.slice(1);else t=100;s=v.join(" ").trim(); 
 var f=ktry(s);if((s==0)||tp(f)!=0){O("L is no func");P();return};clearInterval(tick);
 tick=setInterval(function(){var x=ktry(function(){rx(f);return atx(f,kg(gui))});if(x!=0){O(sk(kst(x))+"\n");P()}},t)}
function O(s) { kons.value += s; kons.scrollTo(0, kons.scrollHeight) }
function P()  { kons.value += " " }

function us(s) { return new TextEncoder("utf-8").encode(s) } // uint8array from string
function su(u) { return (u.length) ? new TextDecoder("utf-8").decode(u) : "" }

//var funcs = {{{fncs}}}
function xx(x) { return x.toString(16).padStart(8,'0') }
function dump(x, n) {
 var p = x >>> 2
 O("\n"+xx(p)+" ")
 for (var i=0; i<n; i++) {
  O(" "+xx(K.U[p+i]))
  if ((i>0)&&((i+1)%8==0)&&((i+1)<n)) O("\n"+xx(x+4*i+4)+" ")
  else if ((i>0)&&((i+1)%4==0)) O(" ")
 }
 O("\n")
}
function cstr(s) {
 var n = s.length
 var x = mk(1, n)
 for (var i=0;i<n;i++) K.C[8+x+i] = s.charCodeAt(i);
 return x
}
function sk(x) { var n = nn(x); dx(x); return su(K.C.slice(8+x, 8+x+n))}

var bak
function ktry(s) {
 try{
  var x = (typeof(s)==="function")?s():val(cstr(s))
  bak = K.C.slice(0, 1<<K.U[32])
  return x
 } catch(e) {
  console.log(e)
  indicate(K.I[35], K.I[36])
  clearInterval(tick)
  K.I[35]=0;K.I[36]=0
  K.C.set(bak)
 }
 return 0
}
function apl(s){var a="⍴⍳×÷⌈⌊⌽⍋⍒⍉←⋄¨".split(""); var k="#!*%|&|<>+:;'".split(""); return s.split("").map(x=>{var i=a.indexOf(x); return (i==-1)?x:k[i]}).join("")}
function E(s) { var x=ktry(apl(s)); if(x!=0) O(sk(kst(x))+"\n") }

function imgSize(w, h) { cnv.style.width = w; cnv.style.height = h; cnv.width = w; cnv.height = h }
function draw(w, h, p) {
  imgSize(w, h)
  var u = new Uint8ClampedArray(K.C.slice(p, p+4*w*h))
  var d = new ImageData(u, w, h)
  for (var i=3; i<d.data.length; i+=4) d.data[i] = 255
  ctx.putImageData(d, 0, 0)
}
function edit(name) { var u;
 if(name.startsWith("`")){
  var x = ktry(name.slice(1)); if(x==0){P();return}; u=us(sk(kst(x)))
 } else { u = getfile(name); if(u===false) u=us("") }
 edname = name; ed = true; konstore = kons.value;
 kons.value = (u.length>0) ? su(u) : ""
 kons.className = "edit"
 kons.scrollTo(0,0);
}
function qed() { // quit edit
 var t = kons.value; kons.value = konstore; kons.scrollTo(0, kons.scrollHeight); ed = false
 if(edname.startsWith("`")){edname=edname.slice(1);ktry(edname+":"+t)}
 else                       putfile(edname, us(t))
}
ae(kons,"contextmenu", function(e) { // button-3 search
 var l = kons.selectionEnd-kons.selectionStart; if(e.button==2&l>0) {
  pd(e); var t = kons.value.substring(kons.selectionStart,kons.selectionEnd)
  var f = function(a){ return kons.value.indexOf(t,a) }; var n = f(kons.selectionEnd)
  if (n<0){n=f(0)}; kons.setSelectionRange(n,n+l); }
})
function hash(s){window.location.hash=encodeURIComponent(s.trim())}

// drop file (store in fs[`FILE])
window.ondragover=function(e){pd(e)}
window.ondrop=function(e){pd(e);if (e.dataTransfer.items){for (var i=0;i<e.dataTransfer.items.length;i++){if(e.dataTransfer.items[i].kind=='file'){var file=e.dataTransfer.items[i].getAsFile();addfile(file)}}}else for(vari=0;i<e.dataTransfer.files.length;i++)addfile(e.dataTransfer.files[i])}
function addfile(x){
 var r = new FileReader()
 r.onload = function(){
  var u = new Uint8Array(r.result)
  if(x.name.endsWith(".ws")){setWorkspace(u);O("←"+x.name+"\n");P()}
  else{putfile(x.name, u); O("fs[`"+x.name+"] /"+String(u.length)+"\n");P()}
 }
 r.readAsArrayBuffer(x)
}
function setWorkspace(u){var s=K.U[32];while((1<<s)<u.length)s++;grow(s);K.C.set(u);bak=K.C.slice(0, 1<<K.U[32])}
function putfile(name, u) { // from Uint8Array
 var k = sc(cstr(name))
 var v = mk(1,u.length)
 K.C.set(u,v+8)
 var kv = mkd(k, enl(v))
 var fs = sc(cstr("fs")); rx(fs)
 var fsv= lup(fs, 0)
 if(fsv==0) dx(asn(fs, 0, kv))
 else       dx(asn(fs, 0, cat(fsv, kv)))
}

// get file with \wFILE or \w (workspace k.ws) from fs[`FILE]
function getfile(name) {
 console.log("k.w size:", 1<<K.U[32])
 if(name==="k.ws"){return K.C.slice(0, 1<<K.U[32])}
 else{
  var x = ktry("fs[`"+name+"]");
  if(x!=0){var n=nn(x);dx(x);return K.C.slice(8+x,8+x+n)}
 }
 return false
}
function download(name) {
 name = (name===""?"k.ws":name)
 var u = getfile(name)
 if (u !== false) {
  var b = new Blob([u], {type:"application/octet-stream"})
  dl.href = URL.createObjectURL(b)
  dl.download = name
  dl.click()
 }
}

//gui \gVAR \g(remove)
function mkgui(s){var x,g,k,v,ki,vi,i,n;if(gui){gui.destroy();gui=undefined};if(s.length==0)return;x=ktry(s);if(x==0)return;
 gui=new dat.GUI();var e=gui.domElement.style;e.position="absolute";e.right="50%"
 if(tp(x)==7){rx(x);rx(x);k=til(x);v=val(x);n=nn(k);for(i=0;i<n;i++){rx(k);rx(v);ki=atx(k,mki(i));vi=atx(v,mki(i));gadd(gui,sk(cs(ki)),vi);dx(vi)};dx(k);dx(v)}
 else gadd(gui,s,x); dx(x)}
function gadd(g,key,x){var a,n,v,vi,r,i;n=nn(x);if(n==0)return;o={};switch(tp(x)){
 case 0:rx(x);o[key]=callback(x);g.add(o,key);return    /*x leaks*/          //button/function
 case 1:v=su(K.C.slice(8+x,8+x+n));o[key]=v;g.add(o,key);return              //string
 case 2:a=x>>>2;v=K.I.slice(2+a,2+a+n);
        if (n==1){o[key]=v[0];g.add(o,key).step(1)}                          //int
   else if((n==2)&&v[1]==1){r=false;if(v[0]!=0)r=true;o[key]=r;g.add(o,key)} //checkbox
   else if((n==2)&&v[1]==0){                                                 //color
           r=v[0];o[key]=[r&255,(r>>>8)&255,(r>>>16)&255];g.addColor(o,key)} 
   else if (n==2){o[key]=v[0];g.add(o,key,0,v[1]).step(1)}                   //int[0,max]
   else if (n> 2){o[key]=v[0];g.add(o,key,v[1],v[2]).step(1)};return         //int[min,max]
 case 3:a=x>>>3;v=K.F.slice(1+a,1+a+n);o[key]=v[0];
        if (n==1) g.add(o,key)                                //float
   else if (n==2) g.add(o,key,0,v[1])                         //float[0,max]
   else if (n==3) g.add(o,key,v[1],v[2])                      //float[min,max]
   else if (n==4) g.add(o,key,v[1],v[2]).step(v[3]);return    //float[min,max] stepsize
 case 5:v=[];for(i=0;i<n;i++){rx(x);r=atx(x,mki(i));v.push(sk(cs(r)));dx(r)}
      o[key]=v[0];g.add(o,key,v);return                       // symbols->options
 case 7:var f=g.addFolder(key);rx(x);rx(x);a=til(x);v=val(x); // dict->folder
      n=nn(a);for(i=0;i<n;i++){rx(a);rx(v); vi=atx(v,mki(i));
      gadd(f,sk(cs(atx(a,mki(i)))),vi);dx(vi);}; dx(a);dx(v);
}}
function callback(x){return function(){rx(x);var r=atx(x,kg(gui));if(r!=0)O(sk(kst(r))+"\n")}}
function kg(g){ //k dict from gui
 var i,c,ci,r,k,v;k=mk(5,0);v=mk(6,0);if(g==undefined)return mkd(k,v)
 c=g.__controllers;for(i=0;i<c.length;i++){ci=c[i];r=ci.getValue()
      if (typeof(r)==="function") continue
 else if (typeof(r)==="boolean")             r=mki(r+0)                    //bool->int
 else if((typeof(r)==="string")&&ci.__input) r=cstr(r)                     //string->chars
 else if (typeof(r)==="string")              r=sc(cstr(r))                 //options->symbol
 else if (ci.__step===1)                     r=mki(r)                      //int
 else if (ci.__color){var x=ci.__color;      r=mki((x.b<<16)+(x.g<<8)+x.r)}//color
 else { var f = mk(3,1); K.F[1+(f>>>3)] = r; r=f                          }//float
 k=cat(k,sc(cstr(ci.property)));v=lcat(v,r)}
 c=g.__folders;for(i in c){k=cat(k,sc(cstr(i)));v=lcat(v,kg(c[i]))}
 return mkd(k,v)}

function msl(){var b=K.exports.mem.buffer;K.C=new Uint8Array(b);K.U=new Uint32Array(b);K.I=new Int32Array(b);K.F=new Float64Array(b)}
function grow(x){var cur=K.exports.mem.buffer.byteLength;if((1<<x)>cur){var a=(1<<x)-cur;K.exports.mem.grow(a>>>16); msl()};return x}

(async () => {
 initKons()
 const module = await WebAssembly.compile(kwasm.buffer);
 K = await WebAssembly.instantiate(module, { "ext": {"sin":Math.sin,"cos":Math.cos,"log":Math.log,"atan2":Math.atan2,"hypot":Math.hypot,"draw":draw,"grow":grow} });
 msl()
 K.exports.ini(16)
 var e=K.exports;nn=e.nn;tp=e.tp;rx=e.rx;dx=e.dx;mk=e.mk;val=e.val;sc=e.sc;cs=e.cs;mkd=e.mkd;asn=e.asn;kst=e.kst;enl=e.enl;lup=e.lup;cat=e.cat;lcat=e.lcat;atx=e.atx;mki=e.mki;til=e.til
 bak = K.C.slice(0)
 var h = decodeURIComponent(window.location.hash.substr(1))
 window.location.hash = h
 if (h.length > 0) {
  var p = kons.value.length
  kons.value += h
  kons.setSelectionRange(p, kons.value.length)
 }
 imgSize(0,0);kons.focus()
})();
</script></body></html>
