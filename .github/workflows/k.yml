name: ktye/k

on:
  push:
    branches: [ master ]
  pull_request:
    branches: [ master ]

jobs:

  build:
    runs-on: ubuntu-latest
    steps:
    
    - name: set date
      id: date
      run: echo "::set-output name=date::$(date +'%Y-%m-%d')"
   
    - name: checkout ktye/i
      uses: actions/checkout@v2
      with:
        path: i
   
    - name: checkout wg
      uses: actions/checkout@v2
      with:
        repository: ktye/wg
        path: wg
        
    - name: setup go
      uses: actions/setup-go@v2
      with:
        go-version: '1.17'
    
    - name: install wg
      run: cd wg && go install ./cmd/wg

    - name: build i
      run: cd i && go build -v ./
      
    - name: test i
      run: cd i && go test
    
    - name: build k.go amalgamation package
      run: cd i/go && sh mk && go build k.go
      
    - name: build K.go main program
      run: cd i/go && sed -e 's/package k/package main/' -e 's/^func Main/func main/' k.go > K.go && go build K.go && ./K ../k.t -e

    - name: build k.c
      run: | 
        cd i
        wg -c -prefix ktye_ . > k.c
        gcc -o kc -O2 k.c -lm

    - name: test k.c
      run: cd i && ./kc k.t -e

    - name: upload k.c
      uses: actions/upload-artifact@v2
      with:
        name: k.c
        path: i/k.c
        
    - name: checkout sqlite
      uses: actions/checkout@v2
      with:
        repository: sqlite/sqlite
        path: sqlite
        ref: version-3.37.2

    - name: build sqlite.c
      run: |
        mkdir sq
        cd sq
        ../sqlite/configure
        make
        make sqlite3.c
        cp sqlite3.c ../i/+
    
    - name: build ktye.h
      run: cd i/+ && sh mk ktye.h
    
    - name: tar k+
      run: cd i && tar czf k+.tar.gz +/
          
    - name: build k+
      run: |
        sudo apt-get install -y liblapacke-dev libcairo2-dev libsqlite3-dev
        cd i/+
        sh mk.lin
        
    - name: test k+
      run: |
        cd i/+
        ./k+ mat/mat.k -e
        ./k+ draw/draw.k -e
        
    - name: delete release
      uses: dev-drprasad/delete-older-releases@v0.2.0
      with:
        keep_latest: 0
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    
    - name: release
      id: create_release
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: latest
        release_name: Release ${{ steps.date.outputs.date }} ${{ github.ref }}
        
    - name: upload k.go
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./i/go/k.go
        asset_name: k.go
        asset_content_type: text/plain
    
    - name: upload K.go
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./i/go/K.go
        asset_name: K.go
        asset_content_type: text/plain
          
    - name: upload k.c
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./i/k.c
        asset_name: k.c
        asset_content_type: text/plain
    
    - name: upload ktye.h
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./i/+/ktye.h
        asset_name: ktye.h
        asset_content_type: text/plain
    
    - name: upload k+
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./i/k+.tar.gz
        asset_name: k+.tar.gz
        asset_content_type: application/tar+gzip
